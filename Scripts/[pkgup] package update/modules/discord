#!/usr/bin/env bash
# ============================================
#   DISCORD AUTO-UPDATER
#   Author: RDXFGXY1
#   Version: 2.1
#   Usage: update-discord [--yes|-y]
# ============================================

# Parse arguments FIRST (before set -u)
SKIP_CONFIRM=false
if [ $# -gt 0 ]; then
  if [ "$1" = "--yes" ] || [ "$1" = "-y" ]; then
    SKIP_CONFIRM=true
  fi
fi

# Now enable strict mode
set -euo pipefail
IFS=$'\n\t'

# Configuration
INSTALL_DIR="/opt/discord"
TMPDIR="$(mktemp -d -t discord-update.XXXXXX)"
DESKTOP_FILE="/usr/share/applications/discord.desktop"
LOGFILE="/var/log/update-discord.log"
VERSION_FILE="/opt/discord/resources/build_info.json"

# Colors
ESC='\033['
RESET="${ESC}0m"
BOLD="${ESC}1m"
RED="${ESC}31m"; GREEN="${ESC}32m"; YELLOW="${ESC}33m"; BLUE="${ESC}34m"
MAG="${ESC}35m"; CYAN="${ESC}36m"; WHITE="${ESC}37m"

# Rainbow helper
rainbow() {
  local text="$1"
  local i=0
  local colors=("${RED}" "${YELLOW}" "${GREEN}" "${CYAN}" "${BLUE}" "${MAG}")
  local out=""
  for ((i=0; i<${#text}; i++)); do
    local c="${text:i:1}"
    out+="${colors[$((i % ${#colors[@]}))]}${c}"
  done
  echo -e "${out}${RESET}"
}

log() {
  echo -e "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOGFILE"
}

cleanup() {
  rm -rf "$TMPDIR"
}
trap 'cleanup; log "Interrupted. Exiting."; echo -e "\n${RED}Update aborted.${RESET}"; exit 1' INT TERM

# ASCII Dragon
print_dragon() {
cat <<'DRAGON'
                       ___====-_  _-====___
                 _--^^^#####//      \\#####^^^--_
              _-^##########// (    ) \\##########^-_
             -############//  |\^^/|  \\############-
           _/############//   (@::@)   \\############\_
          /#############((     \\//     ))#############\
         -###############\\    (oo)    //###############-
        -#################\\  / VV \  //#################-
       -###################\\/      \//###################-
      _#/|##########/\######(   /\   )######/\##########|\#_
      |/ |#/\#/\#/\/  \#/\##\  /  \  /##/\#/  \/\#/\#/\#| \|
      `  |/  V  V  `   V  \\#\/\/\/\/#/  V   '  V  V  \|  '
         `   `  `      `   /  /    \  \   '      '  '   '
DRAGON
}

# Anime quotes
quotes=(
  "People's lives don't end when they die, it ends when they lose faith. - Itachi Uchiha"
  "Whatever you lose, you'll find it again. But what you throw away forever stays that way. - Kenshin Himura"
  "It's not the face that makes someone a monster; it's the choices they make with their lives. - Naruto Uzumaki"
  "To know sorrow is not terrifying. What is terrifying is to know you can't go back to happiness you could have. - Matsumoto Rangiku"
  "If you don't take risks, you can't create a future. - Monkey D. Luffy"
)

rand_quote() {
  local i=$((RANDOM % ${#quotes[@]}))
  echo "${quotes[$i]}"
}

# Spinner
spinner() {
  local pid="$1"
  local msg="$2"
  local delay=0.08
  while kill -0 "$pid" 2>/dev/null; do
    printf "\r| %s" "$msg"
    sleep "$delay"
    printf "\r/ %s" "$msg"
    sleep "$delay"
    printf "\r- %s" "$msg"
    sleep "$delay"
    printf "\r\\ %s" "$msg"
    sleep "$delay"
  done
  printf "\r"
}

# Progress bar
progress_bar() {
  local seconds="$1"
  local msg="$2"
  local i=0
  printf "%s\n" "$msg"
  while [ $i -le "$seconds" ]; do
    local pct=$((i * 100 / seconds))
    local done=$((pct / 4))
    local left=$((25 - done))
    printf "\r["
    
    # Print filled blocks
    local j=0
    while [ $j -lt "$done" ]; do
      printf "â–ˆ"
      j=$((j + 1))
    done
    
    # Print empty blocks
    j=0
    while [ $j -lt "$left" ]; do
      printf " "
      j=$((j + 1))
    done
    
    printf "] %3s%%" "$pct"
    i=$((i + 1))
    sleep 0.08
  done
  printf "\n"
}

# System info
print_sysinfo() {
  local host
  local os
  local kernel
  local uptime
  local shell
  local mem
  
  host="$(hostnamectl --static 2>/dev/null || hostname)"
  os="$(grep '^PRETTY_NAME' /etc/os-release 2>/dev/null | cut -d= -f2 | tr -d '\"' || echo "Linux")"
  kernel="$(uname -r)"
  uptime="$(uptime -p 2>/dev/null | sed 's/up //' || echo "unknown")"
  shell="$(basename "$SHELL")"
  mem="$(free -h 2>/dev/null | awk '/Mem:/ {print $3 " / " $2}' || echo "unknown")"
  
  echo -e "${CYAN}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${RESET}"
  echo -e " ${BOLD}Host:${RESET} $host    ${BOLD}OS:${RESET} $os"
  echo -e " ${BOLD}Kernel:${RESET} $kernel    ${BOLD}Uptime:${RESET} $uptime"
  echo -e " ${BOLD}Shell:${RESET} $shell    ${BOLD}Memory:${RESET} $mem"
  echo -e "${CYAN}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${RESET}"
}

# Check requirements
check_requirements() {
  log "Checking requirements..."
  if command -v wget >/dev/null 2>&1; then
    DL_CMD="wget"
  elif command -v curl >/dev/null 2>&1; then
    DL_CMD="curl"
  else
    echo -e "${RED}Error: neither wget nor curl is installed.${RESET}"
    exit 1
  fi
  return 0
}

# Get current installed version
get_current_version() {
  if [ -f "$VERSION_FILE" ]; then
    local version
    version=$(grep -oP '"version"\s*:\s*"\K[^"]+' "$VERSION_FILE" 2>/dev/null || echo "unknown")
    echo "$version"
  else
    echo "not installed"
  fi
}

# Get latest available version from Discord (quick check)
get_latest_version() {
  local temp_dir
  temp_dir=$(mktemp -d)
  local version="unknown"
  
  # Try to extract just the version file (lightweight check)
  if curl -sL "https://discord.com/api/download?platform=linux&format=tar.gz" 2>/dev/null | \
     tar -xz -C "$temp_dir" "Discord/resources/build_info.json" 2>/dev/null; then
    version=$(grep -oP '"version"\s*:\s*"\K[^"]+' "$temp_dir/Discord/resources/build_info.json" 2>/dev/null || echo "unknown")
  fi
  
  rm -rf "$temp_dir"
  echo "$version"
}

# Ask for confirmation
confirm_action() {
  local prompt="$1"
  if [ "$SKIP_CONFIRM" = true ]; then
    return 0
  fi
  
  echo -e "${YELLOW}${prompt}${RESET}"
  read -p "Continue? [y/N] " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    log "User cancelled operation"
    echo -e "${YELLOW}Operation cancelled.${RESET}"
    cleanup
    exit 0
  fi
}

# Main
main() {
  mkdir -p "$(dirname "$LOGFILE")"
  log "Starting Discord updater."
  clear
  print_dragon
  echo
  echo -e "$(rainbow " â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ")"
  echo -e "$(rainbow "Updating Discord â€” GARUDA ASIAN DRAGON EDITION")"
  echo

  print_sysinfo
  echo
  echo -e "${MAG}Quote:${RESET} \"$(rand_quote)\""
  echo

  # Check current version
  local current_version
  current_version=$(get_current_version)
  echo -e "${CYAN}Current Discord version:${RESET} ${BOLD}$current_version${RESET}"
  
  # Check latest version available
  echo -e "${CYAN}Checking latest version...${RESET}"
  local latest_version
  latest_version=$(get_latest_version)
  echo -e "${CYAN}Latest Discord version:${RESET} ${BOLD}$latest_version${RESET}"
  echo
  
  # Compare versions
  if [ "$current_version" = "$latest_version" ] && [ "$latest_version" != "unknown" ] && [ "$current_version" != "not installed" ]; then
    echo -e "${GREEN}âœ“ Discord is already up to date!${RESET}"
    echo -e "${CYAN}You have the latest version: ${BOLD}$current_version${RESET}"
    confirm_action "Do you want to reinstall anyway?"
  elif [ "$current_version" = "not installed" ]; then
    echo -e "${YELLOW}Discord is not installed yet.${RESET}"
    confirm_action "Proceed with fresh installation?"
  else
    echo -e "${YELLOW}â†’ Update available: ${BOLD}$current_version${RESET} ${YELLOW}â†’${RESET} ${GREEN}${BOLD}$latest_version${RESET}"
    confirm_action "Proceed with update?"
  fi

  echo -ne "${CYAN}Checking connectivity to discord.com...${RESET} "
  if curl -sSfI https://discord.com >/dev/null 2>&1; then
    echo -e "${GREEN}OK${RESET}"
  else
    echo -e "${RED}Failed${RESET} â€” network or DNS problem."
    log "Network check failed."
    exit 1
  fi

  log "Downloading latest Discord tarball to $TMPDIR"
  echo -e "\n${YELLOW}Downloading latest Discord...${RESET}"
  
  # Download with proper command construction
  (
    if [ "$DL_CMD" = "wget" ]; then
      wget -q --show-progress --progress=bar:force -O "$TMPDIR/discord.tar.gz" "https://discord.com/api/download?platform=linux&format=tar.gz"
    else
      curl -L --progress-bar -o "$TMPDIR/discord.tar.gz" "https://discord.com/api/download?platform=linux&format=tar.gz"
    fi
  ) & dlpid=$!

  spinner "$dlpid" "Downloading..."
  wait "$dlpid" || { echo -e "${RED}Download failed.${RESET}"; log "Download failed."; exit 1; }
  echo -e "${GREEN}Download complete.${RESET}"
  log "Downloaded to $TMPDIR/discord.tar.gz"

  echo -e "${YELLOW}Extracting files...${RESET}"
  progress_bar 30 "Extracting (simulated progress bar)"
  tar -xzf "$TMPDIR/discord.tar.gz" -C "$TMPDIR"
  if [ ! -d "$TMPDIR/Discord" ]; then
    echo -e "${RED}Extraction failed.${RESET}" && log "Extraction failed." && exit 1
  fi
  log "Extraction OK."

  # Verify downloaded version
  local downloaded_version="unknown"
  if [ -f "$TMPDIR/Discord/resources/build_info.json" ]; then
    downloaded_version=$(grep -oP '"version"\s*:\s*"\K[^"]+' "$TMPDIR/Discord/resources/build_info.json" 2>/dev/null || echo "unknown")
    echo -e "${CYAN}Downloaded version:${RESET} ${BOLD}$downloaded_version${RESET}"
    log "Downloaded version: $downloaded_version"
  fi
  
  echo

  echo -e "${YELLOW}Removing old installation (if any)...${RESET}"
  progress_bar 12 "Cleaning old installs"
  sudo rm -rf "$INSTALL_DIR" "${INSTALL_DIR}"* || true
  log "Old installation removed."

  echo -e "${YELLOW}Installing new version to ${INSTALL_DIR}...${RESET}"
  sudo mv "$TMPDIR/Discord" "$INSTALL_DIR"
  sudo chown -R root:root "$INSTALL_DIR" || true
  sudo chmod -R 755 "$INSTALL_DIR" || true
  log "Moved new Discord to $INSTALL_DIR"

  echo -e "${YELLOW}Creating launcher and symlink...${RESET}"
  sudo ln -sf "$INSTALL_DIR/Discord" /usr/bin/discord
  sudo tee "$DESKTOP_FILE" >/dev/null <<EOF
[Desktop Entry]
Name=Discord
Comment=Chat for Communities and Friends
Exec=/usr/bin/discord
Icon=$INSTALL_DIR/discord.png
Terminal=false
Type=Application
Categories=Network;Chat;
EOF
  sudo chmod 644 "$DESKTOP_FILE"
  log "Symlink and desktop file created."

  echo
  echo -e "${GREEN}${BOLD}Finalizingâ€¦${RESET}"
  progress_bar 18 "Finalizing installation"

  echo
  print_dragon
  echo -e "${GREEN}${BOLD}ðŸŽ‰ Discord was updated successfully!${RESET}"
  echo -e "${CYAN}Installed version:${RESET} ${BOLD}$downloaded_version${RESET}"
  echo -e "${CYAN}Run:${RESET} ${BOLD}discord${RESET} or launch from your apps menu."
  log "Update finished successfully. Version: $downloaded_version"

  cat <<'CELEB'
                 \  ^__^
                  \ (â€¢ã……â€¢)
                    /   \
                   (     )
                    `---'
CELEB

  cleanup
}

check_requirements
main
